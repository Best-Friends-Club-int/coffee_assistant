// --- –ü–µ—Ä–µ–∫–ª–∞–¥–∏ ---
const translations = {
  uk: {
    startTitle: "‚òï –¢–≤—ñ–π –∫–∞–≤–æ–≤–∏–π –Ω–∞—Å—Ç—Ä—ñ–π",
    startText: "–•–æ—á–µ—à –¥—ñ–∑–Ω–∞—Ç–∏—Å—å, —è–∫–∞ –∫–∞–≤–∞ –ø–∞—Å—É—î —Å–∞–º–µ —Ç–≤–æ—î–º—É –Ω–∞—Å—Ç—Ä–æ—é? –ú–∏ –ø—ñ–¥–∫–∏–Ω–µ–º–æ —ñ–¥–µ—é!",
    startBtn: "üöÄ –ü–æ—ó—Ö–∞–ª–∏",
    finalPhrases: [
      "üòè –ß—É–¥–æ–≤–∏–π –≤–∏–±—ñ—Ä! –ó–∞–º–æ–≤ —ñ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–π—Å—è –≤ –Ω–∞—à–æ–º—É –∫–ª—É–±—ñ, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ —â–µ –±—ñ–ª—å—à–µ!",
      "üéØ –£ —Ç–µ–±–µ —á—É–¥–æ–≤–∏–π —Å–º–∞–∫! –ß–∞—Å –∑–∞–º–æ–≤–∏—Ç–∏ –∫–∞–≤—É —Ç–∞ –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ –Ω–∞—à–æ—ó —Å–ø—ñ–ª—å–Ω–æ—Ç–∏!",
      "‚òï –û—Ü–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –ü—Ä–∏–¥–±–∞–π –∫–∞–≤—É —Ç–∞ —Ä–µ—î—Å—Ç—Ä—É–π—Å—è –≤ –∫–ª—É–±—ñ –∫–∞–≤–æ–≤–∏—Ö –µ–Ω—Ç—É–∑—ñ–∞—Å—Ç—ñ–≤.",
      "üòâ –û, —Ç–∞–∫–æ–∂ –æ–¥–Ω–∞ –∑ –º–æ—ó—Ö —É–ª—é–±–ª–µ–Ω–∏—Ö! –ú–µ—Ä—à—ñ–π —É –Ω–∞—à—É –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω—É —Å–ø—ñ–ª—å–Ω–æ—Ç—É!",
      "‚ú® –£ —Ç–µ–±–µ —î —Å–º–∞–∫ –¥–æ –∂–∏—Ç—Ç—è! –ü–æ–¥—ñ–ª–∏—Å—å –¥–æ—Å–≤—ñ–¥–æ–º —ñ –ø—Ä–∏—î–¥–Ω—É–π—Å—è –¥–æ –∫–ª—É–±—É!"
    ]
  },
  en: {
    startTitle: "‚òï Your Coffee Mood",
    startText: "Want to know which coffee matches your vibe? Let's find out!",
    startBtn: "üöÄ Let's go",
    finalPhrases: [
      "üòè Great choice! Order now and join our club for more!",
      "üéØ You‚Äôve got amazing taste! Time to order and join our community!",
      "‚òï That‚Äôs the result! Just grab your coffee and sign up.",
      "üòâ One of my favorites too! Join our global coffee family!",
      "‚ú® You definitely have taste! Share it and join our club!"
    ]
  },
  es: {
    startTitle: "‚òï Tu estado de √°nimo cafetero",
    startText: "¬øQuieres saber qu√© caf√© encaja con tu estado de √°nimo? ¬°Vamos a descubrirlo!",
    startBtn: "üöÄ Empezar",
    finalPhrases: [
      "üòè ¬°Gran elecci√≥n! Haz tu pedido y √∫nete a nuestro club.",
      "üéØ ¬°Tienes un gusto excelente! Es hora de unirte a nuestra comunidad.",
      "‚òï ¬°Ese es el resultado! Compra tu caf√© y reg√≠strate en el club.",
      "üòâ ¬°Tambi√©n uno de mis favoritos! √önete a nuestra familia cafetera.",
      "‚ú® ¬°Tienes buen gusto! Comp√°rtelo y √∫nete al club."
    ]
  },
  ru: {
    startTitle: "‚òï –¢–≤–æ–µ –∫–æ—Ñ–µ–π–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ",
    startText: "–•–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å, –∫–∞–∫–æ–π –∫–æ—Ñ–µ –ø–æ–¥—Ö–æ–¥–∏—Ç —Ç–≤–æ–µ–º—É –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é? –î–∞–≤–∞–π –ø—Ä–æ–≤–µ—Ä–∏–º!",
    startBtn: "üöÄ –ü–æ–µ—Ö–∞–ª–∏",
    finalPhrases: [
      "üòè –û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä! –ó–∞–∫–∞–∑—ã–≤–∞–π –∏ –≤—Å—Ç—É–ø–∞–π –≤ –Ω–∞—à –∫–ª—É–±.",
      "üéØ –£ —Ç–µ–±—è –æ—Ç–ª–∏—á–Ω—ã–π –≤–∫—É—Å! –í—Ä–µ–º—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –Ω–∞—à–µ–º—É —Å–æ–æ–±—â–µ—Å—Ç–≤—É.",
      "‚òï –í–æ—Ç —Ç–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –ö—É–ø–∏ –∫–æ—Ñ–µ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è –≤ –∫–ª—É–±–µ.",
      "üòâ –û, —Ç–æ–∂–µ –æ–¥–∏–Ω –∏–∑ –º–æ–∏—Ö –ª—é–±–∏–º—ã—Ö! –°–∫–æ—Ä–µ–µ –≤—Å—Ç—É–ø–∞–π –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ.",
      "‚ú® –£ —Ç–µ–±—è –µ—Å—Ç—å –≤–∫—É—Å –∫ –∂–∏–∑–Ω–∏! –î–µ–ª–∏—Å—å –∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –∫–ª—É–±—É."
    ]
  },
  pl: {
    startTitle: "‚òï Tw√≥j kawowy nastr√≥j",
    startText: "Chcesz wiedzieƒá, jaka kawa pasuje do twojego nastroju? Sprawd≈∫my!",
    startBtn: "üöÄ Start",
    finalPhrases: [
      "üòè ≈öwietny wyb√≥r! Zam√≥w teraz i do≈ÇƒÖcz do naszego klubu.",
      "üéØ Masz doskona≈Çy gust! Czas do≈ÇƒÖczyƒá do spo≈Çeczno≈õci.",
      "‚òï To jest wynik! Kup kawƒô i zarejestruj siƒô w klubie.",
      "üòâ Te≈º jeden z moich ulubionych! Do≈ÇƒÖcz do naszej kawowej rodziny.",
      "‚ú® Masz ≈õwietny smak! Podziel siƒô nim i do≈ÇƒÖcz do klubu."
    ]
  }
};

// --- –í–∏–±—ñ—Ä –º–æ–≤–∏ ---
let lang = navigator.language.slice(0, 2);
if (!translations[lang]) lang = "en";

// --- –ê–Ω—Ç–∏–∫–µ—à + —Ä–µ—Ñ–µ—Ä–∞–ª ---
const ref = new URLSearchParams(window.location.search).get("ref") || "default";
function adjustLink(link) {
  const ts = Date.now();
  return `${link}?ref=${ref}&_=${ts}`;
}

// --- –ó–º—ñ–Ω–Ω—ñ –ª–æ–≥—ñ–∫–∏ ---
let currentQ = 0;
let userProfile = {};
let selectedMethod = null;
let selectedDrink = null;

const quizEl = document.getElementById("quiz");
const resultEl = document.getElementById("result");
const startScreen = document.getElementById("start-screen");
const startBtn = document.getElementById("startBtn");

// --- –î–æ–¥–∞—Ç–∏ —Ç–µ–≥–∏ ---
function addTags(tags) {
  for (const [key, value] of Object.entries(tags)) {
    if (!userProfile[key]) userProfile[key] = 0;
    userProfile[key] += value;
  }
}

// --- –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è ---
function showQuestion() {
  if (
    selectedMethod === "filter" &&
    questions[currentQ].answers.some(a => a.drink)
  ) {
    showResult();
    return;
  }

  quizEl.innerHTML = `<h2>${questions[currentQ].text[lang]}</h2>`;
  const gallery = document.createElement("div");
  gallery.className = "gallery";

  questions[currentQ].answers.forEach(a => {
    const card = document.createElement("div");
    card.className = "gallery-item";
    card.innerHTML = `<img src="${a.img}" alt=""><p>${a.text[lang]}</p>`;
    card.onclick = () => {
      if (a.tags) addTags(a.tags);
      if (a.method) selectedMethod = a.method;
      if (a.drink) selectedDrink = a.drink;

      currentQ++;
      if (currentQ < questions.length) {
        showQuestion();
      } else {
        showResult();
      }
    };
    gallery.appendChild(card);
  });

  quizEl.appendChild(gallery);
}

// --- –ü–æ–∫–∞–∑–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç ---
function showResult() {
  let coffees = [...coffeeProfiles];

  if (selectedMethod === "filter") {
    const filterCoffees = coffees.filter(c => c.category === "filter");
    const main = filterCoffees[0];
    const alt = filterCoffees[1];

    let html = `
      <h2>${translations[lang].startTitle}</h2>
      <h3>${main.name}</h3>
      <img src="${main.img}" alt="${main.name}">
      <div class="final-phrase">${translations[lang].finalPhrases[Math.floor(Math.random() * translations[lang].finalPhrases.length)]}</div>
      <a href="${adjustLink(main.link)}" target="_blank"><button>‚òï ${translations[lang].startBtn}</button></a>
    `;

    if (alt) {
      html += `<h3>‚ú® ${lang === "uk" ? "–í–∞–º —Ç–∞–∫–æ–∂ –º–æ–∂–µ —Å–ø–æ–¥–æ–±–∞—Ç–∏—Å—è:" : "You may also like:"}</h3>
      <div class="gallery">
        <a href="${adjustLink(alt.link)}" target="_blank" class="gallery-item">
          <img src="${alt.img}" alt="${alt.name}">
          <p>${alt.name}</p>
        </a>
      </div>`;
    }

    resultEl.innerHTML = html;
    quizEl.classList.add("hidden");
    resultEl.classList.remove("hidden");
    return;
  }

  if (selectedDrink === "milk" || selectedDrink === "cappuccino") {
    coffees = coffees.filter(c => c.category !== "filter");
  }

  if (selectedDrink === "espresso") {
    if (Math.random() > 0.1) {
      coffees = coffees.filter(c => c.category !== "filter");
    }
  }

  let scores = coffees.map(coffee => {
    let score = 0;
    for (const [tag, weight] of Object.entries(userProfile)) {
      if (coffee.tags[tag]) score += Math.min(weight, coffee.tags[tag]);
    }
    return { ...coffee, score };
  });

  scores.sort((a, b) => b.score - a.score);
  const mainCoffee = scores[0];
  const recommendations = scores.slice(1, 3);

  let html = `
    <h2>${translations[lang].startTitle}</h2>
    <h3>${mainCoffee.name}</h3>
    <img src="${mainCoffee.img}" alt="${mainCoffee.name}">
    <div class="final-phrase">${translations[lang].finalPhrases[Math.floor(Math.random() * translations[lang].finalPhrases.length)]}</div>
    <a href="${adjustLink(mainCoffee.link)}" target="_blank"><button>‚òï ${translations[lang].startBtn}</button></a>
  `;

  if (recommendations.length > 0) {
    html += `<h3>‚ú® ${lang === "uk" ? "–í–∞–º —Ç–∞–∫–æ–∂ –º–æ–∂–µ —Å–ø–æ–¥–æ–±–∞—Ç–∏—Å—è:" : "You may also like:"}</h3><div class="gallery">`;
    recommendations.forEach(c => {
      html += `
        <a href="${adjustLink(c.link)}" target="_blank" class="gallery-item">
          <img src="${c.img}" alt="${c.name}">
          <p>${c.name}</p>
        </a>`;
    });
    html += `</div>`;
  }

  resultEl.innerHTML = html;
  quizEl.classList.add("hidden");
  resultEl.classList.remove("hidden");
}

// --- –°—Ç–∞—Ä—Ç ---
startBtn.addEventListener("click", () => {
  startScreen.classList.add("hidden");
  quizEl.classList.remove("hidden");
  currentQ = 0;
  userProfile = {};
  selectedMethod = null;
  selectedDrink = null;
  showQuestion();
});